<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Scores</title>
        <script src="http://live.12urenloop.be/js/boxxy.js"></script>
        <script src="http://live.12urenloop.be/js/jquery-1.7.1.min.js"></script>
        <script src="http://live.12urenloop.be/socket.io/socket.io.js"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>

        <link rel="stylesheet" type="text/css" href="http://live.12urenloop.be/css/application.css">
    </head>
    <body>
        <div id="main">
            <div id="navigation">
                <a href="/scores">Scores</a>
                <a href="/dj-contest">DJ Contest</a>
                <a href="/special-laps">Speciale rondes</a>
            </div>
            <div id="content">
                <h1>Scores</h1>
                <div id="notification"></div>
                <div id="ranking"></div>
                <div id="laps" height="205px"></div>
            </div>
            <div id="footer">
                <p>
                    Built with love by
                    <a href="http://zeus.ugent.be">Zeus WPI</a>.
                </p>
            </div>
        </div>

        <script>
            // Set up boxxy
            var boxxy = boxxy.initialize(),
                boxxyHost = 'http://live.12urenloop.be:8080';

            // Set up D3 vars
            var margin = {top: 12, right: 0, bottom: 0, left: 0},
                width = 460 - margin.left - margin.right,
                rowHeight = 20;

            var rankingSvg;

            $(document).ready(function () {

                // Adds the position in the ranking to the data
                function addRankingInformation(teams){
                    var data = teams.sort(function(a, b) { return b.laps - a.laps });
                    for (var i = 0; i < data.length; i++) {
                        data[i].rankingPosition = i;
                    }
                    return data;
                }

                // This functions draws the complete visualisation
                // teams should be an array with teams
                function redrawEverything(teams) {
                    // Create a D3 readable array and add ranking
                    var data = addRankingInformation(teams);

                    var height = data.length * rowHeight;

                    // Set up the main svg
                    rankingSvg = d3.select("#ranking")
                      .append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                      .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                    // Add a g for every team
                    var teams = rankingSvg.selectAll(".team")
                        .data(data, function(d) { return d.id})
                      .enter().append("g")
                        .attr("class", "team")
                        .attr("id", function (d) { return d.id; })
                        .attr("transform", function (d) { return "translate(0," + (d.rankingPosition * rowHeight) + ")"});

                    // Add the team position
                    teams.append("text")
                        .attr("class", "position")
                        .attr("x", 20)
                        .attr("text-anchor", "end")
                        .text(function (d) { return (d.rankingPosition + 1) + "."; });

                    // Add the team names to the left hand side
                    teams.append("text")
                        .attr("class", "teamName")
                        .attr("x", 25)
                        .text(function (d) { return d.name; });

                    // Add the lap count to the right hand side
                    teams.append("text")
                        .attr("class", "lapCount")
                        .attr("x", width)
                        .attr("text-anchor", "end")
                        .text(function (d) { return d3.format(",")(d.laps).replace(",", "."); });
                }

                // This function updates the lapcount and order
                // teams should be an array
                function update(teams){
                    // Create a D3 readable array and add ranking
                    var data = addRankingInformation(teams);

                    var team = d3.selectAll(".team")
                        .data(data, function(d) { return d.id})
                      .transition()
                        .attr("transform", function (d) { return "translate(0," + (d.rankingPosition * rowHeight) + ")"});

                    team.selectAll(".position")
                        .text(function (d) { return (d.rankingPosition + 1) + "."; });

                    team.selectAll(".lapCount")
                        .text(function (d) { return d3.format(",")(d.laps).replace(",", "."); });
                }

                // This function gets executed when the state is reset: so either
                // the client initially connects, or when it reconnects after a
                // failure.
                boxxy.onPutState = function (state) {
                    // Out with the old, in with the new
                    $("#ranking").html("");
                    redrawEverything(boxxy.teamsByScore());
                }

                // This function gets executed when a team completes a lap.
                boxxy.onAddLap = function (lap) {
                    update(boxxy.teamsByScore());
                }

                boxxy.onUpdate = function () {}

                // Listen to boxxy
                boxxy.listen(boxxyHost);
            });
        </script>
    </body>
</html>
